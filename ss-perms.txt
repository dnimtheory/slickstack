#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-perms.txt #############################################
#### path: /var/www/ss-perms #######################################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: resets all file and user permissions across entire SlickStack server #################
#### ss version: SlickStack alpha ss6c #############################################################
#### module version: n/a ###########################################################################
####################################################################################################

## Ref: https://unix.stackexchange.com/a/203372/353848 ##

## include SlickStack configuration ##
source /var/www/ss-config

####################################################################################################
#### Reset Permissions: Ubuntu Users, Groups, Etc ##################################################
####################################################################################################

## create wordpress group if does not exist ##
addgroup wordpress &> /dev/null

## add SFTP (non-sudo) user and Nginx server user to the wordpress group ##
if [[ -z "$SFTP_USER" ]]; then 
    adduser $user wordpress &> /dev/null
else 
    adduser $SFTP_USER wordpress &> /dev/null
fi



adduser www-data wordpress &> /dev/null

## reset Ubuntu system files permissions ##
chown root:root /etc/ssh/sshd_config
chown root:root /etc/sudoers
chmod 440 /etc/sudoers

####################################################################################################
#### Reset Permissions: SlickStack Core Files (Cron Jobs + Scripts) ################################
####################################################################################################

chown root:root /var/www
chown root:root /var/www/*cron*
chown root:root /var/www/ss*
chmod 755 /var/www
chmod 700 /var/www/*cron*
chmod 700 /var/www/ss*

####################################################################################################
#### Reset Permissions: WordPress Files (WP Core + SlickStack) #####################################
####################################################################################################

## create directories if do not exist already ##
mkdir -p /var/www/html/wp-content/temp
mkdir -p /var/www/html/wp-content/uploads
mkdir -p /var/www/html/wp-content/upgrade

## chown ##
if [[ -z "$SFTP_USER" ]]; then 
    chown -R $user:wordpress /var/www/html
else 
    chown -R $SFTP_USER:wordpress /var/www/html
fi

## ensure files exist ##
if [ ! -f "/var/www/html/wp-content/blacklist.txt" ]; then 
    touch "/var/www/html/wp-content/blacklist.txt"
fi
    
if [ ! -f "/var/www/html/wp-content/functions.php" ]; then 
    touch "/var/www/html/wp-content/functions.php"
fi

# chown -R www-data:www-data /var/www/html/wp-config.php
chown -R www-data:wordpress /var/www/html/wp-content/temp
chown -R www-data:wordpress /var/www/html/wp-content/mu-plugins
chown -R www-data:wordpress /var/www/html/wp-content/uploads
chown -R www-data:www-data /var/www/html/wp-content/blacklist.txt
chown -R www-data:wordpress /var/www/html/wp-content/object-cache.php
chown -R www-data:wordpress /var/www/html/wp-content/functions.php

## chmod ##
chmod 755 /var/www/html
chmod -R g+s /var/www/html/
chmod 660 /var/www/html/wp-config.php
chmod 775 /var/www/html/wp-content/temp
chmod 775 /var/www/html/wp-content/uploads
chmod 400 /var/www/html/wp-content/blacklist.txt
chmod 664 /var/www/html/wp-content/object-cache.php
chmod 664 /var/www/html/wp-content/functions.php

find /var/www/html/ -type d -exec chmod 775 {} \;
find /var/www/html/ -type f -not -path "*var/www/html/wp-content/uploads*" -exec chmod 664 {} \;
find /var/www/html/wp-content/uploads/ -not -name "*.jpg" -not -name "*.jpeg" -not -name "*.png" -not -name "*.bmp" -not -name "*.webp" -not -name "*.gif" -not -name "*.tiff" -not -name "*.mp4" -not -name "*.vid" -type f -exec chmod 664 {} \;

####################################################################################################
#### Reset Permissions: Log Files (Optimized For SlickStack) #######################################
####################################################################################################

## create logs directory (will not overwrite if exists already) ##
mkdir -p /var/www/logs

## ensure all log files exist ##
if [ ! -f "/var/www/logs/clamav.log" ]; then touch "/var/www/logs/clamav.log"; fi
if [ ! -f "/var/www/logs/error.log" ]; then touch "/var/www/logs/error.log"; fi
if [ ! -f "/var/www/logs/mysql.log" ]; then touch "/var/www/logs/mysql.log"; fi
if [ ! -f "/var/www/logs/nginx.log" ]; then touch "/var/www/logs/nginx.log"; fi
if [ ! -f "/var/www/logs/redis.log" ]; then touch "/var/www/logs/redis.log"; fi

## reset permissions ##
chown -R www-data:www-data /var/www/logs
chown -R clamav:clamav /var/www/logs/clamav.log*
# chown -R www-data:www-data /var/www/logs/error.log*
# chown -R mysql:mysql /var/www/logs/mysql.log*
# chown -R www-data:www-data /var/www/logs/nginx.log*
chown -R redis:redis /var/www/logs/redis.log*
chmod -R 775 /var/www/logs

####################################################################################################
## Reset Permissions: Nginx Files ##################################################################
####################################################################################################

chown root:root /etc/nginx/nginx.conf
chown root:root /etc/nginx/fastcgi.conf

####################################################################################################
## Reset Permissions: FastCGI Cache (Nginx) Files ##################################################
####################################################################################################

## create cache directory (will not overwrite if exists already) ##
mkdir -p /var/www/cache

## reset permissions ##
chown www-data:www-data /var/www/cache
chmod 775 /var/www/cache

####################################################################################################
## Reset Permissions: SlickStack Meta Files ########################################################
####################################################################################################

## create meta directory (will not overwrite if exists already) ##
mkdir -p /var/www/meta

## reset permissions ##
chown www-data:www-data /var/www/meta
chmod 775 /var/www/meta

####################################################################################################
## Reset Permissions: OpenSSL (Nginx) Files ########################################################
####################################################################################################

if [[ -f "/etc/ssl/nginx.crt" ]]; then 
    chown root:root /etc/ssl/nginx.crt
    chmod -R 700 /etc/ssl/nginx.crt
fi

if [[ -f "/etc/ssl/nginx.key" ]]; then 
    chown root:root /etc/ssl/nginx.key
    chmod -R 700 /etc/ssl/nginx.key
fi

if [[ -f "/etc/ssl/nginx.pem" ]]; then 
    chown root:root /etc/ssl/nginx.pem
    chmod -R 700 /etc/ssl/nginx.pem
fi

####################################################################################################
## Reset Permissions: PHP-FPM Files ################################################################
####################################################################################################

## old ##
mkdir -p /var/run/php

## reset php permissions ##
# chown www-data:www-data /var/run/php
chown root:root /etc/php/7.2/fpm/php.ini
chown root:root /etc/php/7.2/fpm/php-fpm.conf
chown root:root /etc/php/7.2/cli/php.ini

## create mysql files if do not exist ##
mkdir -p /var/run/mysqld

####################################################################################################
## Reset Permissions: MySQL Files ##################################################################
####################################################################################################

## reset MySQL permissions ##
chown mysql:mysql /var/run/mysqld
chown root:root /etc/mysql/my.cnf
chown root:root /etc/mysql/mysql.cnf
chown root:root /etc/mysql/mysql.conf.d/mysqld.cnf

####################################################################################################
## Reset Permissions: Redis Files ##################################################################
####################################################################################################

## create Redis directory (will not overwrite if exists already) ##
mkdir -p /var/run/redis

## reset permissions ##
chown redis:redis /var/run/redis
chown redis:redis /etc/redis/redis.conf

####################################################################################################
## Reset Permissions: WP-CLI Files #################################################################
####################################################################################################

## reset WP-CLI permissions ##
## https://github.com/wp-cli/wp-cli/issues/3181 ##
## https://github.com/wp-cli/wp-cli/issues/1241 ##
## https://www.alexgeorgiou.gr/wp-cli-www-data-user-permissions-linux/ ##
chown root:root /usr/local/bin/
chown www-data:www-data /usr/local/bin/wp
chmod 6775 /usr/local/bin/wp
