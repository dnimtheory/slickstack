#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-worker.txt ############################################
#### path: /var/www/ss-worker ######################################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: performs various maintenance tasks and downloads latest ss-check file ################
#### ss version: SlickStack alpha ss6c #############################################################
#### module version: n/a ###########################################################################
####################################################################################################

## include SlickStack configuration ##
source /var/www/ss-config

####################################################################################################
#### delete any previous + leftover temporary files ################################################
####################################################################################################

rm -R -f /tmp/ss*
rm -R -f /tmp/*cron*
rm -R -f /tmp/blacklist*

####################################################################################################
#### update the ss-check file to latest version (improves stability by separating) #################
####################################################################################################

# download latest versions ##
wget --no-cache --no-cookies -O /tmp/1-cron-often.txt http://mirrors.slickstack.io/1-cron-often.txt
wget --no-cache --no-cookies -O /tmp/ss-check.txt http://mirrors.slickstack.io/ss-check.txt

## rename files ##
mv /tmp/1-cron-often.txt /tmp/1-cron-often
mv /tmp/ss-check.txt /tmp/ss-check

## copy files to /var/www/ ##
cp -R -f -d --no-preserve=mode,ownership /tmp/1-cron-often /var/www/1-cron-often
cp -R -f -d --no-preserve=mode,ownership /tmp/ss-check /var/www/ss-check

####################################################################################################
#### reset permissions #############################################################################
####################################################################################################

chown root:root /var/www/ss*
chown root:root /var/www/*cron*
chmod 700 /var/www/ss*
chmod 700 /var/www/*cron*

####################################################################################################
## update blacklist.txt file to latest version for Plugin Blacklist (MU plugin) ####################
####################################################################################################

## download latest blacklist (or custom blacklist) ##
if [[ -z "$PLUGIN_BLACKLIST_SOURCE" ]];
then wget --no-cache --no-cookies -O /tmp/blacklist.txt http://mirrors.slickstack.io/wordpress/blacklist.txt
else wget --no-check-certificate --no-cache --no-cookies -O /tmp/blacklist.txt "$PLUGIN_BLACKLIST_SOURCE"
fi

## move blacklist.txt to /var/www/html/wp-content/ ##
cp -R -f -d --no-preserve=mode,ownership /tmp/blacklist.txt /var/www/html/wp-content/blacklist.txt

## reset permissions ##
chown www-data:wordpress /var/www/html/wp-content/blacklist.txt
chmod 664 /var/www/html/wp-content/blacklist.txt

####################################################################################################
#### delete any previous + leftover temporary files ################################################
####################################################################################################

rm -R -f /tmp/ss*
rm -R -f /tmp/*cron*
rm -R -f /tmp/blacklist*

####################################################################################################
#### various TEMPORARY tasks (custom Bash commands, etc) ###########################################
####################################################################################################

## uncomment for approximately ~45 minutes for urgent MU plugins updates ##
# source /var/www/ss-muplugs
